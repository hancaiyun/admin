<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>admin</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <link rel="stylesheet" th:href="@{/frame/css/font.css}">
    <link rel="stylesheet" th:href="@{/frame/css/xadmin.css}">
</head>

<div id="uploadPatchForm" class="roundRect">
        <div  id="uploadLoadingDiv">
    <div class="layui-progress" lay-showpercent="true" lay-filter="demo" >
            <div class="layui-progress-bar layui-bg-red" lay-percent="0%"></div>
                </div>
        </div>
        <form class="layui-form" enctype="multipart/form-data">
            <div class="layui-form-item layui-upload">
        <span id="uploadName" style="line-height: 3;"></span>
        <button type="button" class="layui-btn layui-btn-normal" id="test8" style="float: right;"><i class="layui-icon"></i></button>
            </div>
            <div class="layui-form-item">
            </div>
            <div class="layui-form-item">
        <div class="layui-input-block">
            <a class="roundCornerDiv aLineGray" href="javascript:layer.closeAll();">
        <span type="reset" class="ButtonText popupCloseBtn">取消</span>
            </a>
            <a class="roundCornerDiv aLineOrange">
        <button class="ButtonText submitBtn" type="button" id="test9">立即提交</button>
        </a>
        </div>
            </div>
    </form>
</div>

<script th:src="@{/frame/js/jquery-3.4.1.min.js}"></script>
<script th:src="@{/frame/layui/layui.js}"></script>
<script th:src="@{/frame/js/xadmin.js}"></script>
<script>

    //创建监听函数
    var xhrOnProgress=function(fun) {
        xhrOnProgress.onprogress = fun; //绑定监听
        //使用闭包实现监听绑
        return function() {
            //通过$.ajaxSettings.xhr();获得XMLHttpRequest对象
            var xhr = $.ajaxSettings.xhr();
            //判断监听函数是否为函数
            if (typeof xhrOnProgress.onprogress !== 'function')
                return xhr;
            //如果有监听函数并且xhr对象支持绑定时就把监听函数绑定上去
            if (xhrOnProgress.onprogress && xhr.upload) {
                xhr.upload.onprogress = xhrOnProgress.onprogress;
            }
            return xhr;
        }
    }

    layui.use(['upload','element','layer'], function(){
        var upload = layui.upload,element = layui.element,layer = layui.layer;
        upload.render({
            elem: '#test8'
            ,url: 'upload'
            ,async: false
            ,method: 'post'
            ,data: {
                upgradeType: function(){
                    return $("input[name='upgradeType']:checked").val();
                }
            }
            ,auto: false
            ,xhr:xhrOnProgress
            ,progress:function(value){//上传进度回调 value进度值
                element.progress('demo', value+'%')//设置页面进度条
            }
            ,accept: 'file' //普通文件
            ,exts: 'zip' //只允许上传压缩文件
            ,field:'uploadFile'
            ,bindAction: '#test9'
            ,choose: function(obj){
                var uploadFileInput=$(".layui-upload-file").val();
                var uploadFileName=uploadFileInput.split("\\");
                $("#uploadName").text(uploadFileName[uploadFileName.length-1]);
            }
            ,before: function(obj){
                layer.load(); //上传loading
            }
            ,done: function(res){
                layer.msg("上传成功");
            }
            ,error: function(index, upload){
                element.progress('demo', '0%');
                layer.msg('上传失败');
            }
        });
    });

</script>
</body>
</html>